package unipi.iot;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;

import org.eclipse.californium.core.CoapClient;
import org.eclipse.californium.core.CoapResponse;
import org.eclipse.californium.core.coap.MediaTypeRegistry;

public class MainApp {

	public static ArrayList<CoapObserverClient> coapObserverClients = new ArrayList<CoapObserverClient>();
	public static ArrayList<Thermometer> thermometers = new ArrayList<Thermometer>();
	public static ArrayList<Alarm> alarms = new ArrayList<Alarm>();

	public static void main(String[] args) throws IOException, InterruptedException {

		runServer();
		showResources();
		
		while (true) {
			try {
				Integer index, gap = null;

				switch (command) {
				case 1:
					if ((index = getNodeFromId()) != null)
						switchCooling("ON", coolers.get(index));
					break;
				case 2:
					if ((index = getNodeFromId()) != null)
						switchCooling("OFF", coolers.get(index));
					break;
				case 3:
					showResourcesInformation();
					break;
				case 4:
					if ((index = getNodeFromId()) != null) {
						String value = thermostats.get(index).getLastTemperatureValue();
						System.out.println("Last temperature value registered by node "+ Integer.toString(index) + ": " + value);
					}
					break;
				case 5:
					if ((index = getNodeFromId()) != null) {  
						gap = thermostats.get(index).getTemperatureGap();
						if (gap != null)
							System.out.println(gap > 2?"Cooling system should be activated":"Increase inside safety range");
						else
							System.out.println("Not enough temperatures sensed yet by node "+Integer.toString(index));
					}	
					break;
				case 6:
					System.exit(0);
					break;
				default:
					showOperations();
					break;
				}

			} catch (Exception e) {
				System.out.println("Invalid input, here are the available commands\n");
				showOperations();
				e.printStackTrace();
			}
		}
	}

	public static void runServer() {
		new Thread() {
			public void run() {
				Server server = new Server();
				server.startServer();
			}
		}.start();
	}

	public static void showResources() {
		if(thermometers.isEmpty())
			System.out.println("No resources registered yet.");
		else{
			System.out.println("List of the Resources in the system:");
			for (int i = 0; i < thermometers.size(); i++) {
				Thermometer t = thermometers.get(i);
				Alarm a = alarms.get(i);
				System.out.println(
						+i + "\tThermometer: " + t.getNodeAddress() + " " + t.getResourcePath());
				System.out.println(+i + "\tAlarm: " + a.getNodeAddress() + " "
						+ a.getResourcePath() + "\n");
			}
		} 
			
	}

	public static void showResourcesInformation() {
		System.out.println("Information about the resources: \n");
		for (int i = 0; i < thermostats.size(); ++i) {
			showSingleResourceInformation(i);
			System.out.println("\n -------------------------------------------- \n");
		}
	}

	public static void triggerAlarm(String state, Alarm a) {
		CoapClient client = new CoapClient(a.getResourceURI());
		CoapResponse response = client.post("", MediaTypeRegistry.TEXT_PLAIN)
		String code = response.getCode().toString();
		if (!code.startsWith("2")) {
			System.out.println("Error: " + code);
			return;
		}
		a.setState(a.getState());
		System.out.println("Alarm is: " + state);
	}

	public static void showSingleResourceInformation(Integer index) {
		Alarm a = alarms.get(index);
		String stateValue = a.getState() ? "ON" : "OFF";
		System.out.println(index + "\t" + a.getNodeAddress() + " " + a.getResourcePath()
				+ "\n\t\tState: " + stateValue + "\n");

		Thermometer t = thermometers.get(index);
		System.out.println(index + "\t" + t.getNodeAddress() + " " + t.getResourcePath());
		ArrayList<String> list = t.getTemperatureValues();
		for (int j = 0; j < list.size(); ++j)
			System.out.println("\t\tId: " + j + "\tValue: " + list.get(j));
	}

}
